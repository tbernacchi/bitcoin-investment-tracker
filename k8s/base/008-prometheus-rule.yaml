---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: bitcoin-alert
  namespace: bitcoin-investment-tracker
  labels:
    release: my-kube-prometheus-stack
spec:
  groups:
    - name: bitcoin.rules
      interval: 15m
      rules:
        - alert: BitcoinPriceVariation
          expr: bitcoin_price_change_percent > 0
          for: 1m
          labels:
            severity: info
            namespace: monitoring
          annotations:
            summary: "ðŸš¨ Bitcoin Price Update ðŸš¨"
            description: |
              Price change: {{ $value | printf "%.2f" }}%
              Current price: $ {{ with query "bitcoin_current_price_usd" }}{{ . | first | value | printf "%.2f" }}{{ end }}

        # Test alert for small changes
        - alert: BitcoinProfitTarget
          expr: bitcoin_price_change_percent >= 0.5  # Simplified expression for testing
          for: 30s
          labels:
            severity: info
            namespace: monitoring
          annotations:
            summary: "ðŸš¨ Test Alert ðŸš¨"
            description: |
              ðŸŽ‰ TEST ALERT!
              Price change detected: {{ $value | printf "%.2f" }}%
              
              Current change: {{ $value | printf "%.2f" }}%
              Current price: $ {{ with query "bitcoin_current_price_usd" }}{{ . | first | value | printf "%.2f" }}{{ end }}

              Test alert - will be adjusted back to 5% after testing

        # Profit alerts (5% to 100%)
        - alert: BitcoinProfitTarget
          expr: |
            bitcoin_price_change_percent >= 5 * floor(bitcoin_price_change_percent / 5)
            and
            bitcoin_price_change_percent > 0
            and
            bitcoin_price_change_percent <= 100
          for: 1m
          labels:
            severity: info
            namespace: monitoring
          annotations:
            summary: "ðŸš¨ Investment Alert ðŸš¨"
            description: |
              ðŸŽ‰ PROFIT ALERT!
              Your investment has increased by {{ $value | printf "%.2f" }}%!
              
              Current profit: {{ $value | printf "%.2f" }}%
              Next target: {{ ceil ($value / 5) * 5 }}%
              Current price: $ {{ with query "bitcoin_current_price_usd" }}{{ . | first | value | printf "%.2f" }}{{ end }}

              Sent via Bitcoin Investment Tracker ðŸ“ˆ

        # Loss alerts (-5% to -50%)
        - alert: BitcoinLossAlert
          expr: |
            bitcoin_price_change_percent <= 5 * ceil(bitcoin_price_change_percent / 5)
            and
            bitcoin_price_change_percent < 0
            and
            bitcoin_price_change_percent >= -50
          for: 1m
          labels:
            severity: warning
            namespace: monitoring
          annotations:
            summary: "ðŸš¨ Investment Alert ðŸš¨"
            description: |
              ðŸ“‰ LOSS ALERT!
              Your investment has decreased by {{ $value | printf "%.2f" }}%!
              
              Current loss: {{ $value | printf "%.2f" }}%
              Next level: {{ floor ($value / 5) * 5 }}%
              Current price: $ {{ with query "bitcoin_current_price_usd" }}{{ . | first | value | printf "%.2f" }}{{ end }}

              Sent via Bitcoin Investment Tracker ðŸ“Š

        # Special 100% profit alert
        - alert: BitcoinProfitTarget100Percent
          expr: bitcoin_price_change_percent >= 100
          for: 1m
          labels:
            severity: info
            namespace: monitoring
          annotations:
            summary: "ðŸš¨ Investment Alert ðŸš¨"
            description: |
              ðŸŽ‰ 100% PROFIT!
              Congratulations! Your investment has doubled in value!
              
              Current profit: {{ $value | printf "%.2f" }}%
              Current price: $ {{ with query "bitcoin_current_price_usd" }}{{ . | first | value | printf "%.2f" }}{{ end }}

              Sent via Bitcoin Investment Tracker ðŸš€

        # Special 50% loss alert
        - alert: BitcoinLossAlert50Percent
          expr: bitcoin_price_change_percent <= -50
          for: 1m
          labels:
            severity: critical
            namespace: monitoring
          annotations:
            summary: "ðŸš¨ Investment Alert ðŸš¨"
            description: |
              âš ï¸ 50% LOSS!
              Warning! Your investment has lost half its value!
              
              Current loss: {{ $value | printf "%.2f" }}%
              Current price: $ {{ with query "bitcoin_current_price_usd" }}{{ . | first | value | printf "%.2f" }}{{ end }}

              Sent via Bitcoin Investment Tracker âš ï¸
